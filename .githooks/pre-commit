#!/bin/bash

# Pre-commit hook para prevenir commits de informaci√≥n sensible
# Este script verifica que no se est√©n commiteando secrets, credenciales o informaci√≥n sensible

echo "üîí Verificando seguridad del commit..."

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Patrones a buscar (secrets, API keys, passwords, etc.)
PATTERNS=(
    "password\s*=\s*['\"][^'\"]+['\"]"
    "api[_-]?key\s*=\s*['\"][^'\"]+['\"]"
    "secret\s*=\s*['\"][^'\"]+['\"]"
    "token\s*=\s*['\"][^'\"]+['\"]"
    "cosmos[_-]?key\s*=\s*['\"][^'\"]+['\"]"
    "jwt[_-]?secret\s*=\s*['\"][^'\"]+['\"]"
    "connection[_-]?string\s*=\s*['\"][^'\"]+['\"]"
    "mongodb\+srv://[^'\"]+"
    "postgresql://[^'\"]+"
    "mysql://[^'\"]+"
    "redis://[^'\"]+"
    "Bearer\s+[A-Za-z0-9]{20,}"
    "sk-[A-Za-z0-9]{32,}"
    "AIza[0-9A-Za-z\\-_]{35}"
    "AKIA[0-9A-Z]{16}"
    "[0-9a-f]{32}"
    "-----BEGIN\s+(RSA\s+)?PRIVATE\s+KEY-----"
)

# Archivos a verificar
FILES=$(git diff --cached --name-only --diff-filter=ACM)

ERRORS=0

for file in $FILES; do
    # Saltar archivos binarios
    if [[ "$file" =~ \.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|pdf|zip|tar|gz)$ ]]; then
        continue
    fi
    
    # Saltar node_modules y otros directorios ignorados
    if [[ "$file" =~ ^(node_modules|dist|build|\.git|\.vscode)/ ]]; then
        continue
    fi
    
    # Verificar cada patr√≥n
    for pattern in "${PATTERNS[@]}"; do
        if git diff --cached "$file" | grep -iE "$pattern" > /dev/null 2>&1; then
            echo -e "${RED}‚ùå ERROR:${NC} Posible informaci√≥n sensible detectada en: $file"
            echo -e "${YELLOW}   Patr√≥n encontrado:${NC} $pattern"
            ERRORS=$((ERRORS + 1))
        fi
    done
done

# Verificar archivos .env
if echo "$FILES" | grep -E "\.env$|\.env\." > /dev/null; then
    echo -e "${RED}‚ùå ERROR:${NC} Intentando commitear archivo .env"
    echo -e "${YELLOW}   Los archivos .env NO deben estar en el repositorio${NC}"
    ERRORS=$((ERRORS + 1))
fi

# Verificar archivos de credenciales
if echo "$FILES" | grep -iE "(secret|credential|password|key|token)" > /dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  ADVERTENCIA:${NC} Archivo con nombre sospechoso detectado"
    echo -e "${YELLOW}   Verifica que no contenga informaci√≥n sensible${NC}"
fi

# Resultado final
if [ $ERRORS -gt 0 ]; then
    echo ""
    echo -e "${RED}üö´ Commit bloqueado:${NC} Se detectaron $ERRORS problema(s) de seguridad"
    echo -e "${YELLOW}Por favor, revisa y elimina cualquier informaci√≥n sensible antes de hacer commit${NC}"
    exit 1
else
    echo -e "${GREEN}‚úÖ Verificaci√≥n de seguridad completada${NC}"
    exit 0
fi

